# 音声同期処理

```
┌─────────────────┐    
│ 音声入力　　      │    
│                 │    
│ マイク           │────┐
│ AVAudioRecorder │    │
└─────────────────┘    │
                       │
┌─────────────────┐    │    ┌─────────────────┐    ┌─────────────────┐
│ 音声セグメント 　　│    │    │ コンポジション 　　│    │ エクスポート音声 　│
│                 │    │    │                 │    │                 │
│ セグメント1　     │◀───┘    │ AVMutable-      │    │ M4Aファイル      │
│ セグメント2　     │────────▶│ Composition     │───▶│ AACエンコード 　  │
│ セグメント3　     │         │ タイム調整　      │    │ 44.1kHz,モノラル　│
└─────────────────┘         └─────────────────┘    └─────────────────┘
                                                            │
┌─────────────────┐                             ┌───────────▼─────────┐
│ 描画データ　      │                             │ SwiftDataストレージ　 │
│                 │                             │                     │
│ ラインセグメント　 │                             │ モデル：　　          │
│ 色値　           │────────────────────────────▶│ Artwork　　　        │
│ 太さデータ　　　　 │                             │ - imageData　　　    │
└─────────────────┘                             │ - audioData　　　    │
                                                └─────────────────────┘
                                                            │
                                               ┌────────────▼────────────┐
                                               │ ギャラリー再生　　         │
                                               │                         │
                                               │ AVAudioPlayer           │
                                               │ 同期表示　　              │
                                               └─────────────────────────┘
```

上の図はEchoArtにおける音声録音、処理、および同期パイプラインの全体を示しています：

1. **音声キャプチャ**: 音声入力はアクティブな描画期間中にセグメントで録音されます
2. **セグメント管理**: 音声セグメントは一時的に別々のファイルとして保存されます
3. **コンポジション**: AVMutableCompositionはセグメントを連続したタイムラインに整列させます
4. **エクスポート処理**: コンポジションはAACエンコーディングを使用した単一のM4Aファイルとしてエクスポートされます
5. **統一ストレージ**: 視覚的アートワークと音声録音の両方がSwiftDataに一緒に保存されます
6. **同期再生**: ギャラリーでは、アートワークを見ながら音声を再生できます

このアプローチにより以下が確保されます：
- メモリ効率（アクティブな描画中のみ録音）
- シームレスな音声連続性（セグメント間に可聴ギャップなし）
- 最適化されたストレージ（良好な音質でコンパクトなファイル形式）
- 統一されたデータ管理（アートワークと音声が常にペアのまま）
